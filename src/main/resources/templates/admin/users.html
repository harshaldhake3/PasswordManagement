<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="fragments/layout :: layout('Users', ~{::body})">
<body>
  <h3 class="mb-3">Users</h3>
  <div class="table-responsive">
  <table class="table table-hover align-middle" data-table>
    <thead>
      <tr>
        <th>ID</th><th>Username</th><th>Email</th><th>Roles</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="u : ${users}">
        <td th:text="${u.id}">1</td>
        <td th:text="${u.username}">alice</td>
        <td th:text="${u.email}">a@x.com</td>
        <td>
          <span class="badge bg-secondary me-1" th:each="r : ${u.roles}" th:text="${r}">USER</span>
        </td>
        <td>
          <span class="badge" th:classappend="${u.enabled} ? 'bg-success' : 'bg-danger'"
                th:text="${u.enabled} ? 'ENABLED' : 'DISABLED'">ENABLED</span>
        </td>
        <td>
          <form class="d-inline" th:action="@{|/admin/users/${u.id}/toggle|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="actor" th:value="${#authentication.name}"/>
            <button class="btn btn-sm btn-outline-warning" th:text="${u.enabled} ? 'Disable' : 'Enable'">Disable</button>
          </form>
          <form class="d-inline" th:if="${!#lists.contains(u.roles, T(com.example.passman.model.Role).ADMIN)}"
                th:action="@{|/admin/users/${u.id}/makeAdmin|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="actor" th:value="${#authentication.name}"/>
            <button class="btn btn-sm btn-outline-primary">Make admin</button>
          </form>
          <form class="d-inline" th:if="${#lists.contains(u.roles, T(com.example.passman.model.Role).ADMIN)}"
                th:action="@{|/admin/users/${u.id}/removeAdmin|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="actor" th:value="${#authentication.name}"/>
            <button class="btn btn-sm btn-outline-secondary">Remove admin</button>
          </form>
          <button class="btn btn-sm btn-outline-danger ms-1" data-reset data-id th:attr="data-id=${u.id}">Reset password</button>
          <form class="d-inline" th:action="@{|/admin/users/${u.id}/resetMfa|}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="actor" th:value="${#authentication.name}"/>
            <button class="btn btn-sm btn-outline-dark">Reset MFA</button>
          </form>
        </td>
      </tr>
    </tbody>
  </table>
  </div>
  <div class="alert alert-info">Password reset returns a one-time value in a toast. Share securely.</div>
  <script>
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-reset]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const actor = document.querySelector('input[name=actor]')?.value || '';
      const res = await fetch(`/admin/users/${id}/resetPassword?actor=${encodeURIComponent(actor)}`, {
        method: 'POST',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });
      const pwd = await res.text();
      window.showToast && window.showToast(`New password for user ${id}: ${pwd}`);
    });
  </script>
</body>
</html>
